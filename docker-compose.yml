
networks:
  inmail-network:
    name: inmail-network
    driver: bridge

services:
  inmail:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: inmail
    hostname: api.inmail.local
    networks:
      - inmail-network
    ports:
      - "${SMTP_PORT:-1025}:1025"  # SMTP
      - "${API_PORT:-8080}:8080"    # API
    environment:
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - API_PORT=${API_PORT:-8080}
      - SMTP_PORT=${SMTP_PORT:-1025}
      - DATABASE_TYPE=${DATABASE_TYPE:-sqlite}
      - DATABASE_DSN=${DATABASE_DSN:-/root/data/inmail.db}
      - JWT_SECRET=${JWT_SECRET:-change-me-in-production}
      - JWT_EXPIRATION_HOURS=${JWT_EXPIRATION_HOURS:-24}
      - BCRYPT_COST=${BCRYPT_COST:-10}
      - ROOT_USERNAME=${ROOT_USERNAME:-admin}
      - ROOT_PASSWORD=${ROOT_PASSWORD:-admin123}
      - ROOT_EMAIL=${ROOT_EMAIL:-admin@inmail.local}
      - SIMULATION_MODE=${SIMULATION_MODE:-success}
      - MAX_ATTACHMENT_SIZE_MB=${MAX_ATTACHMENT_SIZE_MB:-10}
      - RATE_LIMIT_ENABLED=${RATE_LIMIT_ENABLED:-true}
      - RATE_LIMIT_RPS=${RATE_LIMIT_RPS:-100}
      # PostgreSQL settings (if DATABASE_TYPE=postgres)
      - POSTGRES_HOST=${POSTGRES_HOST:-postgres}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_USER=${POSTGRES_USER:-inmail}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-inmail}
      - POSTGRES_DB=${POSTGRES_DB:-inmail}
      - POSTGRES_SSLMODE=${POSTGRES_SSLMODE:-disable}
    volumes:
      - ./data:/root/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 8080 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  web:
    build:
      context: ./web
      dockerfile: Dockerfile
      args:
        # API URL for browser access (browser connects from host, so use localhost or proxy)
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:8080}
        # Docker container URLs (for apps running in Docker)
        NEXT_PUBLIC_DOCKER_API_URL: ${NEXT_PUBLIC_DOCKER_API_URL:-http://api.inmail.local:8080}
        NEXT_PUBLIC_DOCKER_SMTP_HOST: ${NEXT_PUBLIC_DOCKER_SMTP_HOST:-api.inmail.local}
        NEXT_PUBLIC_DOCKER_WEB_URL: ${NEXT_PUBLIC_DOCKER_WEB_URL:-http://web.inmail.local:3000}
        # Host machine URLs (for apps running on host)
        NEXT_PUBLIC_HOST_API_URL: ${NEXT_PUBLIC_HOST_API_URL:-http://localhost:8080}
        NEXT_PUBLIC_HOST_SMTP_HOST: ${NEXT_PUBLIC_HOST_SMTP_HOST:-localhost}
        NEXT_PUBLIC_HOST_WEB_URL: ${NEXT_PUBLIC_HOST_WEB_URL:-http://localhost:3000}
        NEXT_PUBLIC_PROXY_URL: ${NEXT_PUBLIC_PROXY_URL:-http://inmail.local}
    container_name: inmail-web
    hostname: web.inmail.local
    networks:
      - inmail-network
    ports:
      - "${WEB_PORT:-3000}:3000"  # Web UI
    environment:
      - NODE_ENV=production
    depends_on:
      inmail:
        condition: service_started
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 3000 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  # Reverse proxy for host access via inmail.local
  proxy:
    image: nginx:alpine
    container_name: inmail-proxy
    hostname: inmail.local
    networks:
      - inmail-network
    ports:
      - "${PROXY_PORT:-80}:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      inmail:
        condition: service_started
      web:
        condition: service_started
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 80 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Optional: PostgreSQL service
  # Uncomment if using DATABASE_TYPE=postgres
  # postgres:
  #   image: postgres:15-alpine
  #   container_name: inmail-postgres
  #   hostname: postgres.inmail.local
  #   networks:
  #     - inmail-network
  #   environment:
  #     - POSTGRES_USER=${POSTGRES_USER:-inmail}
  #     - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-inmail}
  #     - POSTGRES_DB=${POSTGRES_DB:-inmail}
  #   volumes:
  #     - postgres_data:/var/lib/postgresql/data
  #   ports:
  #     - "${POSTGRES_PORT:-5432}:5432"
  #   restart: unless-stopped
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-inmail}"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5

# volumes:
#   postgres_data:

